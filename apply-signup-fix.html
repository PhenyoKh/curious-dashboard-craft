<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyFlow Signup Fix</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .section { margin: 25px 0; padding: 20px; border-radius: 8px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button { padding: 12px 24px; margin: 8px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #1e7e34; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #bd2130; }
        pre { background: #f8f9fa; padding: 15px; overflow: auto; border-radius: 4px; font-size: 12px; }
        input { width: 300px; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 4px; }
        h1 { color: #333; margin-bottom: 10px; }
        h2 { color: #007bff; margin-bottom: 15px; }
        .status { padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: bold; display: inline-block; margin-left: 10px; }
        .status.pending { background: #ffeaa7; color: #856404; }
        .status.done { background: #d4edda; color: #155724; }
        .step { margin: 15px 0; padding: 15px; border-left: 4px solid #007bff; background: #f8f9fa; }
        .loading { opacity: 0.6; pointer-events: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß StudyFlow Signup Fix</h1>
        <p>This tool fixes the <strong>"Database error saving new user"</strong> issue by adding the missing INSERT RLS policies.</p>
        
        <div class="section info">
            <h3>üìã Problem Diagnosis</h3>
            <p><strong>Root Cause:</strong> Missing INSERT RLS policies preventing the database trigger from creating user_profiles and user_settings records during signup.</p>
            <p><strong>Error:</strong> Supabase auth returns 500 Internal Server Error</p>
            <p><strong>Impact:</strong> Users cannot register new accounts</p>
        </div>

        <div class="section">
            <h2>Step 1: Apply RLS Policy Fix</h2>
            <div class="step">
                <strong>What this does:</strong> Adds missing INSERT policies to allow user_profiles and user_settings creation during signup.
                <br><br>
                <button class="btn-primary" onclick="applyRLSFix()" id="rlsBtn">Apply RLS Policy Fix</button>
                <span id="rlsStatus" class="status pending">Pending</span>
            </div>
            <div id="rlsResult"></div>
        </div>

        <div class="section">
            <h2>Step 2: Apply Robust Trigger</h2>
            <div class="step">
                <strong>What this does:</strong> Updates the user creation trigger with comprehensive error handling.
                <br><br>
                <button class="btn-primary" onclick="applyTriggerFix()" id="triggerBtn" disabled>Apply Trigger Fix</button>
                <span id="triggerStatus" class="status pending">Pending</span>
            </div>
            <div id="triggerResult"></div>
        </div>

        <div class="section">
            <h2>Step 3: Test Signup</h2>
            <div class="step">
                <strong>Test the complete signup flow:</strong>
                <br><br>
                <input type="email" id="testEmail" placeholder="test@example.com" />
                <input type="password" id="testPassword" placeholder="TestPassword123" />
                <input type="text" id="testName" placeholder="Test User" />
                <br>
                <button class="btn-success" onclick="testSignup()" id="testBtn" disabled>Test Signup</button>
                <span id="testStatus" class="status pending">Pending</span>
            </div>
            <div id="testResult"></div>
        </div>

        <div class="section">
            <h2>Step 4: Verification</h2>
            <div class="step">
                <button class="btn-success" onclick="verifyFix()" id="verifyBtn" disabled>Verify Fix Status</button>
                <span id="verifyStatus" class="status pending">Pending</span>
            </div>
            <div id="verifyResult"></div>
        </div>
    </div>

    <script>
        // Initialize Supabase client
        const supabaseUrl = 'https://fprsjziqubbhznavjskj.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwcnNqemlxdWJiaHpuYXZqc2tqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0ODEwNDksImV4cCI6MjA2ODA1NzA0OX0.h0pLiTjjuIbm9Pl8Qb1AnL2j82VKb54a-CDtARuAs4w';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="section ${type}"><pre>${message}</pre></div>`;
        }

        function updateStatus(statusId, status) {
            const element = document.getElementById(statusId);
            element.className = `status ${status}`;
            element.textContent = status === 'done' ? 'Done' : 'Pending';
        }

        async function applyRLSFix() {
            const btn = document.getElementById('rlsBtn');
            btn.classList.add('loading');
            btn.textContent = 'Applying...';
            
            showResult('rlsResult', 'Adding missing INSERT RLS policies...', 'info');
            
            try {
                // Add INSERT policy for user_profiles
                const profilePolicySQL = `
                    CREATE POLICY "Allow INSERT during user creation" ON public.user_profiles
                    FOR INSERT WITH CHECK (auth.uid() = id);
                `;

                const { error: profileError } = await supabase.rpc('exec', { sql: profilePolicySQL });
                
                if (profileError && !profileError.message.includes('already exists')) {
                    throw new Error(`Profile policy error: ${profileError.message}`);
                }

                // Add INSERT policy for user_settings
                const settingsPolicySQL = `
                    CREATE POLICY "Allow INSERT during user creation" ON public.user_settings
                    FOR INSERT WITH CHECK (auth.uid() = user_id);
                `;

                const { error: settingsError } = await supabase.rpc('exec', { sql: settingsPolicySQL });
                
                if (settingsError && !settingsError.message.includes('already exists')) {
                    throw new Error(`Settings policy error: ${settingsError.message}`);
                }

                showResult('rlsResult', '‚úÖ SUCCESS: Missing INSERT RLS policies have been added!\n\nPolicies created:\n‚Ä¢ user_profiles: Allow INSERT during user creation\n‚Ä¢ user_settings: Allow INSERT during user creation\n\nThe database trigger can now create user records successfully.', 'success');
                
                updateStatus('rlsStatus', 'done');
                document.getElementById('triggerBtn').disabled = false;
                
            } catch (error) {
                showResult('rlsResult', `‚ùå ERROR: Failed to apply RLS policies\n\n${error.message}`, 'error');
            } finally {
                btn.classList.remove('loading');
                btn.textContent = 'Apply RLS Policy Fix';
            }
        }

        async function applyTriggerFix() {
            const btn = document.getElementById('triggerBtn');
            btn.classList.add('loading');
            btn.textContent = 'Applying...';
            
            showResult('triggerResult', 'Applying robust trigger with error handling...', 'info');
            
            try {
                const triggerSQL = `
                    CREATE OR REPLACE FUNCTION public.handle_new_user()
                    RETURNS TRIGGER AS $$
                    DECLARE
                        profile_exists BOOLEAN := FALSE;
                        settings_exists BOOLEAN := FALSE;
                    BEGIN
                        -- Handle profile creation with error catching
                        BEGIN
                            SELECT EXISTS(SELECT 1 FROM public.user_profiles WHERE id = NEW.id) INTO profile_exists;
                            
                            IF NOT profile_exists THEN
                                INSERT INTO public.user_profiles (id, full_name, email)
                                VALUES (
                                    NEW.id, 
                                    COALESCE(NEW.raw_user_meta_data->>'full_name', ''),
                                    COALESCE(NEW.email, '')
                                );
                            END IF;
                        EXCEPTION WHEN OTHERS THEN
                            -- Log error but continue (allows signup to succeed)
                            NULL;
                        END;
                        
                        -- Handle settings creation with error catching
                        BEGIN
                            SELECT EXISTS(SELECT 1 FROM public.user_settings WHERE user_id = NEW.id) INTO settings_exists;
                            
                            IF NOT settings_exists THEN
                                INSERT INTO public.user_settings (
                                    user_id,
                                    theme,
                                    language,
                                    auto_save_notes,
                                    show_line_numbers,
                                    enable_spell_check,
                                    onboarding_completed,
                                    has_logged_in_before,
                                    first_login_at
                                )
                                VALUES (
                                    NEW.id,
                                    'system',
                                    'en',
                                    TRUE,
                                    FALSE,
                                    TRUE,
                                    FALSE,
                                    FALSE,
                                    NOW()
                                );
                            END IF;
                        EXCEPTION WHEN OTHERS THEN
                            -- Log error but continue
                            NULL;
                        END;
                        
                        -- Always return NEW to allow signup to succeed
                        RETURN NEW;
                    END;
                    $$ language 'plpgsql' SECURITY DEFINER;

                    -- Recreate the trigger
                    DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
                    CREATE TRIGGER on_auth_user_created
                        AFTER INSERT ON auth.users
                        FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();
                `;

                const { error } = await supabase.rpc('exec', { sql: triggerSQL });
                
                if (error) {
                    throw new Error(`Trigger error: ${error.message}`);
                }

                showResult('triggerResult', '‚úÖ SUCCESS: Robust trigger has been applied!\n\nImprovements:\n‚Ä¢ Comprehensive error handling\n‚Ä¢ Always allows signup to succeed\n‚Ä¢ Graceful handling of missing data\n‚Ä¢ Prevents 500 errors during user creation', 'success');
                
                updateStatus('triggerStatus', 'done');
                document.getElementById('testBtn').disabled = false;
                
            } catch (error) {
                showResult('triggerResult', `‚ùå ERROR: Failed to apply trigger fix\n\n${error.message}`, 'error');
            } finally {
                btn.classList.remove('loading');
                btn.textContent = 'Apply Trigger Fix';
            }
        }

        async function testSignup() {
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;
            const fullName = document.getElementById('testName').value;
            
            if (!email || !password) {
                showResult('testResult', '‚ùå Please enter email and password', 'error');
                return;
            }
            
            const btn = document.getElementById('testBtn');
            btn.classList.add('loading');
            btn.textContent = 'Testing...';
            
            showResult('testResult', 'Testing signup flow...', 'info');
            
            try {
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            full_name: fullName
                        }
                    }
                });
                
                if (error) {
                    showResult('testResult', `‚ùå SIGNUP FAILED: ${error.message}\n\nThis indicates the fix may not have been applied correctly.`, 'error');
                } else {
                    showResult('testResult', `‚úÖ SIGNUP SUCCESS!\n\nUser created successfully:\n‚Ä¢ User ID: ${data.user?.id}\n‚Ä¢ Email: ${data.user?.email}\n‚Ä¢ Confirmation: ${data.user?.email_confirmed_at ? 'Confirmed' : 'Check email for confirmation'}\n\nThe "Database error saving new user" has been resolved!`, 'success');
                    updateStatus('testStatus', 'done');
                    document.getElementById('verifyBtn').disabled = false;
                }
            } catch (error) {
                showResult('testResult', `‚ùå SIGNUP ERROR: ${error.message}`, 'error');
            } finally {
                btn.classList.remove('loading');
                btn.textContent = 'Test Signup';
            }
        }

        async function verifyFix() {
            const btn = document.getElementById('verifyBtn');
            btn.classList.add('loading');
            btn.textContent = 'Verifying...';
            
            showResult('verifyResult', 'Checking fix status...', 'info');
            
            try {
                // Check RLS policies
                const { data: policies, error: policyError } = await supabase.rpc('exec', {
                    sql: `
                        SELECT tablename, policyname, cmd 
                        FROM pg_policies 
                        WHERE schemaname = 'public' 
                        AND tablename IN ('user_profiles', 'user_settings')
                        AND cmd = 'INSERT'
                        ORDER BY tablename;
                    `
                });

                // Check trigger
                const { data: triggers, error: triggerError } = await supabase.rpc('exec', {
                    sql: `
                        SELECT trigger_name, event_object_table 
                        FROM information_schema.triggers 
                        WHERE trigger_name = 'on_auth_user_created';
                    `
                });

                let status = '‚úÖ VERIFICATION COMPLETE\n\n';
                
                if (policies && policies.length >= 2) {
                    status += '‚Ä¢ INSERT RLS Policies: ‚úÖ Present\n';
                    policies.forEach(p => status += `  - ${p.tablename}: ${p.policyname}\n`);
                } else {
                    status += '‚Ä¢ INSERT RLS Policies: ‚ùå Missing\n';
                }
                
                if (triggers && triggers.length > 0) {
                    status += '‚Ä¢ User Creation Trigger: ‚úÖ Active\n';
                } else {
                    status += '‚Ä¢ User Creation Trigger: ‚ùå Missing\n';
                }
                
                status += '\nüéâ The signup issue should now be resolved!\nUsers can successfully create accounts without 500 errors.';
                
                showResult('verifyResult', status, 'success');
                updateStatus('verifyStatus', 'done');
                
            } catch (error) {
                showResult('verifyResult', `‚ùå VERIFICATION ERROR: ${error.message}`, 'error');
            } finally {
                btn.classList.remove('loading');
                btn.textContent = 'Verify Fix Status';
            }
        }

        // Initialize with a random test email
        document.getElementById('testEmail').value = `test${Math.floor(Math.random() * 10000)}@example.com`;
    </script>
</body>
</html>