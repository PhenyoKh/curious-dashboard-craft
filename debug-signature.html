<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayFast Signature Debug</title>
</head>
<body>
    <h1>PayFast Signature Debug</h1>
    <button onclick="debugSignatures()">Debug Signature Generation</button>
    <div id="results"></div>

    <script>
        function md5(string) {
            function md5cycle(x, k) {
                var a = x[0], b = x[1], c = x[2], d = x[3];
                a = ff(a, b, c, d, k[0], 7, -680876936);
                d = ff(d, a, b, c, k[1], 12, -389564586);
                c = ff(c, d, a, b, k[2], 17,  606105819);
                b = ff(b, c, d, a, k[3], 22, -1044525330);
                a = ff(a, b, c, d, k[4], 7, -176418897);
                d = ff(d, a, b, c, k[5], 12,  1200080426);
                c = ff(c, d, a, b, k[6], 17, -1473231341);
                b = ff(b, c, d, a, k[7], 22, -45705983);
                a = ff(a, b, c, d, k[8], 7,  1770035416);
                d = ff(d, a, b, c, k[9], 12, -1958414417);
                c = ff(c, d, a, b, k[10], 17, -42063);
                b = ff(b, c, d, a, k[11], 22, -1990404162);
                a = ff(a, b, c, d, k[12], 7,  1804603682);
                d = ff(d, a, b, c, k[13], 12, -40341101);
                c = ff(c, d, a, b, k[14], 17, -1502002290);
                b = ff(b, c, d, a, k[15], 22,  1236535329);
                a = gg(a, b, c, d, k[1], 5, -165796510);
                d = gg(d, a, b, c, k[6], 9, -1069501632);
                c = gg(c, d, a, b, k[11], 14,  643717713);
                b = gg(b, c, d, a, k[0], 20, -373897302);
                a = gg(a, b, c, d, k[5], 5, -701558691);
                d = gg(d, a, b, c, k[10], 9,  38016083);
                c = gg(c, d, a, b, k[15], 14, -660478335);
                b = gg(b, c, d, a, k[4], 20, -405537848);
                a = gg(a, b, c, d, k[9], 5,  568446438);
                d = gg(d, a, b, c, k[14], 9, -1019803690);
                c = gg(c, d, a, b, k[3], 14, -187363961);
                b = gg(b, c, d, a, k[8], 20,  1163531501);
                a = gg(a, b, c, d, k[13], 5, -1444681467);
                d = gg(d, a, b, c, k[2], 9, -51403784);
                c = gg(c, d, a, b, k[7], 14,  1735328473);
                b = gg(b, c, d, a, k[12], 20, -1926607734);
                a = hh(a, b, c, d, k[5], 4, -378558);
                d = hh(d, a, b, c, k[8], 11, -2022574463);
                c = hh(c, d, a, b, k[11], 16,  1839030562);
                b = hh(b, c, d, a, k[14], 23, -35309556);
                a = hh(a, b, c, d, k[1], 4, -1530992060);
                d = hh(d, a, b, c, k[4], 11,  1272893353);
                c = hh(c, d, a, b, k[7], 16, -155497632);
                b = hh(b, c, d, a, k[10], 23, -1094730640);
                a = hh(a, b, c, d, k[13], 4,  681279174);
                d = hh(d, a, b, c, k[0], 11, -358537222);
                c = hh(c, d, a, b, k[3], 16, -722521979);
                b = hh(b, c, d, a, k[6], 23,  76029189);
                a = hh(a, b, c, d, k[9], 4, -640364487);
                d = hh(d, a, b, c, k[12], 11, -421815835);
                c = hh(c, d, a, b, k[15], 16,  530742520);
                b = hh(b, c, d, a, k[2], 23, -995338651);
                a = ii(a, b, c, d, k[0], 6, -198630844);
                d = ii(d, a, b, c, k[7], 10,  1126891415);
                c = ii(c, d, a, b, k[14], 15, -1416354905);
                b = ii(b, c, d, a, k[5], 21, -57434055);
                a = ii(a, b, c, d, k[12], 6,  1700485571);
                d = ii(d, a, b, c, k[3], 10, -1894986606);
                c = ii(c, d, a, b, k[10], 15, -1051523);
                b = ii(b, c, d, a, k[1], 21, -2054922799);
                a = ii(a, b, c, d, k[8], 6,  1873313359);
                d = ii(d, a, b, c, k[15], 10, -30611744);
                c = ii(c, d, a, b, k[6], 15, -1560198380);
                b = ii(b, c, d, a, k[13], 21,  1309151649);
                a = ii(a, b, c, d, k[4], 6, -145523070);
                d = ii(d, a, b, c, k[11], 10, -1120210379);
                c = ii(c, d, a, b, k[2], 15,  718787259);
                b = ii(b, c, d, a, k[9], 21, -343485551);
                x[0] = add32(a, x[0]);
                x[1] = add32(b, x[1]);
                x[2] = add32(c, x[2]);
                x[3] = add32(d, x[3]);
            }
            function cmn(q, a, b, x, s, t) { return add32(rol32(add32(add32(a, q), add32(x, t)), s), b); }
            function ff(a, b, c, d, x, s, t) { return cmn((b & c) | ((~b) & d), a, b, x, s, t); }
            function gg(a, b, c, d, x, s, t) { return cmn((b & d) | (c & (~d)), a, b, x, s, t); }
            function hh(a, b, c, d, x, s, t) { return cmn(b ^ c ^ d, a, b, x, s, t); }
            function ii(a, b, c, d, x, s, t) { return cmn(c ^ (b | (~d)), a, b, x, s, t); }
            function add32(a, b) { return (a + b) & 0xFFFFFFFF; }
            function rol32(num, cnt) { return (num << cnt) | (num >>> (32 - cnt)); }
            
            var x = [], i;
            var bytes = [];
            for (i = 0; i < string.length; i++) {
                bytes.push(string.charCodeAt(i));
            }
            
            bytes.push(0x80);
            while (bytes.length % 64 !== 56) {
                bytes.push(0);
            }
            
            var len = string.length * 8;
            bytes.push(len & 0xFF); bytes.push((len >>> 8) & 0xFF); bytes.push((len >>> 16) & 0xFF); bytes.push((len >>> 24) & 0xFF);
            bytes.push(0); bytes.push(0); bytes.push(0); bytes.push(0);
            
            for (i = 0; i < x.length; i += 4) {
                x.push(bytes[i] | (bytes[i+1] << 8) | (bytes[i+2] << 16) | (bytes[i+3] << 24));
            }
            
            var h = [0x67452301, 0xEFCDAB89, 0x98BADCFE, 0x10325476];
            
            for (i = 0; i < x.length; i += 16) {
                md5cycle(h, x.slice(i, i + 16));
            }
            
            return h.map(function(n) {
                return (n < 0 ? n + 0x100000000 : n).toString(16).padStart(8, '0');
            }).join('');
        }

        async function debugSignatures() {
            console.log('üîç DEBUG: Comparing browser vs server signature generation');
            
            // EXACT data from last Edge Function response
            const serverPaymentData = {
                "merchant_id": "10000100",
                "merchant_key": "46f0cd694581a",
                "return_url": "https://www.scola.co.za/payment/success?subscription_id=test-subscription-id",
                "cancel_url": "https://www.scola.co.za/payment/cancelled?subscription_id=test-subscription-id",
                "notify_url": "https://fprsjziqubbhznavjskj.supabase.co/functions/v1/payfast-webhook",
                "name_first": "Test",
                "email_address": "test@example.com",
                "m_payment_id": "PF_1755527372015_63axs99lr", // Using exact same payment ID
                "amount": "99.00",
                "item_name": "Test Product",
                "item_description": "Test Product - monthly subscription",
                "custom_str1": "test-user-id",
                "custom_str2": "test-subscription-id",
                "custom_str3": "1"
            };

            // Server signature from Edge Function response
            const serverSignature = "7f31dbe83ece90ba7928a236552c793b";

            // Generate browser signature with EXACT same data
            const { merchant_key, ...signatureParams } = serverPaymentData;
            
            console.log('üîç Signature parameters (excluding merchant_key):', signatureParams);
            console.log('üîç Parameter keys sorted:', Object.keys(signatureParams).sort());

            const signatureString = Object.keys(signatureParams)
                .sort()
                .map(key => `${key}=${encodeURIComponent(signatureParams[key])}`)
                .join('&');
            
            const passphrase = "jt7NOE43FZPn";
            const signatureWithPassphrase = `${signatureString}&passphrase=${passphrase}`;
            const browserSignature = md5(signatureWithPassphrase);

            console.log('üîç FULL Signature string:', signatureWithPassphrase);
            console.log('üîç Browser generated signature:', browserSignature);
            console.log('üîç Server signature (Edge Function):', serverSignature);
            console.log('üîç Signatures match:', browserSignature === serverSignature ? '‚úÖ YES' : '‚ùå NO');

            // Display results
            const results = document.getElementById('results');
            results.innerHTML = `
                <h3>Signature Comparison</h3>
                <p><strong>Browser Signature:</strong> ${browserSignature}</p>
                <p><strong>Server Signature:</strong> ${serverSignature}</p>
                <p><strong>Match:</strong> ${browserSignature === serverSignature ? '‚úÖ YES' : '‚ùå NO'}</p>
                <h4>Signature String:</h4>
                <p style="word-break: break-all; font-family: monospace; background: #f5f5f5; padding: 10px;">
                    ${signatureWithPassphrase}
                </p>
                <h4>Parameters (excluding merchant_key):</h4>
                <pre style="background: #f5f5f5; padding: 10px;">${JSON.stringify(signatureParams, null, 2)}</pre>
            `;

            // If signatures match, test with PayFast
            if (browserSignature === serverSignature) {
                console.log('‚úÖ Signatures match! Testing with PayFast...');
                submitToPayFast({...serverPaymentData, signature: browserSignature});
            } else {
                console.error('‚ùå Signatures do not match. Need to debug further.');
            }
        }

        function submitToPayFast(data) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = 'https://sandbox.payfast.co.za/eng/process';

            for (const [key, value] of Object.entries(data)) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = value;
                form.appendChild(input);
            }

            document.body.appendChild(form);
            console.log('üöÄ Submitting to PayFast...');
            form.submit();
        }
    </script>
</body>
</html>